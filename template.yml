AWSTemplateFormatVersion: "2010-09-09"
Description: HPSkolan Resource Template
Parameters:
  BaseName:
    Description: Base name
    Type: String
    Default: hpskolan-public
  HostedZoneName:
    Description: Hosted zone
    Type: String
    Default: xn--hgskoleprovet-imb.nu.
  DomainName:
    Description: Domain name
    Type: String
    Default: xn--hgskoleprovet-imb.nu
  USEastLambdaArn:
    Description: USEastLambdaArn
    Type: String
    Default: arn:aws:lambda:us-east-1:244998676221:function:hpskolan-lambda-OriginRequestLambdaFunction-1SL2ED15VEWPR:1

Resources:
  Bucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: hpskolan-public
  BucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref Bucket
      PolicyDocument:
        Statement:
          - Action:
              - s3:GetObject
            Effect: Allow
            Resource: !Join ["", ["arn:aws:s3:::", !Ref Bucket, "/*"]]
            Principal:
              CanonicalUser: !GetAtt CloudFrontOriginAccessIdentity.S3CanonicalUserId
  CloudFrontOriginAccessIdentity:
    Type: AWS::CloudFront::CloudFrontOriginAccessIdentity
    Properties:
      CloudFrontOriginAccessIdentityConfig:
        Comment: !Sub "CloudFront OAI for ${DomainName}"
  CloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    DependsOn:
      - Bucket
    Properties:
      DistributionConfig:
        Aliases:
          - !Ref DomainName
        DefaultCacheBehavior:
          AllowedMethods:
            - HEAD
            - OPTIONS
            - GET
          ForwardedValues:
            QueryString: true
          TargetOriginId:
            Ref: BaseName
          ViewerProtocolPolicy: redirect-to-https
          LambdaFunctionAssociations:
            - EventType: origin-request
              LambdaFunctionARN: !Ref USEastLambdaArn
          Compress: true
        CustomErrorResponses:
          - ErrorCode: 403
            ResponseCode: 404
            ResponsePagePath: /404.html
          - ErrorCode: 404
            ResponseCode: 404
            ResponsePagePath: /404.html
        DefaultRootObject: index.html
        Enabled: Yes
        ViewerCertificate:
          SslSupportMethod: sni-only
          AcmCertificateArn: arn:aws:acm:us-east-1:244998676221:certificate/d73f4eeb-ce91-4876-a7f3-694f11805b8e
        Origins:
          - Id:
              Ref: BaseName
            DomainName: !GetAtt Bucket.DomainName
            S3OriginConfig:
              OriginAccessIdentity: !Join ['', ['origin-access-identity/cloudfront/', !Ref CloudFrontOriginAccessIdentity]]

